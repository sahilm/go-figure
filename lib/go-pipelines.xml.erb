<pipelines group="defaultGroup">
  <pipeline name="defaultPipeline">
    <materials>
      <git autoUpdate="false" url="<%= @git_url %>" />
    </materials>
    <stage name="RailsTests">
      <jobs>
        <job name="Test">
          <tasks>
            <exec command="/bin/ln">
              <arg>-sf</arg>
              <arg>/etc/go_saas/database.yml</arg>
              <arg>config/database.yml</arg>
              <runif status="passed" />
            </exec>
            <exec command="bash">
              <arg>-c</arg>
              <arg><%= @params[:init] %></arg>
              <runif status="passed" />
            </exec>
            <exec command="bash">
              <arg>-c</arg>
              <arg><%= @params[:ruby] %> -S bundle exec rake --trace db:drop db:create db:migrate db:test:prepare</arg>
              <runif status="passed" />
            </exec>
            <% if @params[:test_unit] %>
            <exec command="bash">
              <arg>-c</arg>
              <arg><%= @params[:ruby] %> -S bundle exec rake --trace test</arg>
              <runif status="passed" />
            </exec>
            <%end%>
            <% if @params[:rspec] %>
            <exec command="bash">
              <arg>-c</arg>
              <arg><%= @params[:ruby] %> -S bundle exec rake --trace spec</arg>
              <runif status="passed" />
            </exec>
            <%end%>
          </tasks>
        </job>
      </jobs>
    </stage>
  <% if @params[:jasmine] %>
    <stage name="BrowserTests">
      <jobs>
        <job name="Jasmine">
          <environmentvariables>
            <variable name="DISPLAY">
              <value>:1</value>
            </variable>
          </environmentvariables>
          <tasks>
            <exec command="/bin/ln">
              <arg>-sf</arg>
              <arg>/etc/go_saas/database.yml</arg>
              <arg>config/database.yml</arg>
              <runif status="passed" />
            </exec>
            <exec command="bash">
              <arg>-c</arg>
              <arg><%= @params[:init] %></arg>
              <runif status="passed" />
            </exec>
            <exec command="bash">
              <arg>-c</arg>
              <arg><%= @params[:ruby] %> -S bundle exec rake --trace db:create db:migrate</arg>
              <runif status="passed" />
            </exec>
            <exec command="bash">
              <arg>-c</arg>
              <arg><%= @params[:ruby] %> -S bundle exec rake --trace jasmine:headless</arg>
              <runif status="passed" />
            </exec>
          </tasks>
        </job>
      </jobs>
    </stage>
  <% end %>
  <% if @params[:twist] %>
    <stage name="TwistTests">
      <jobs>
        <job name="StartServer">
          <tasks>
            <exec command="/bin/ln">
              <arg>-sf</arg>
              <arg>/etc/go_saas/database.yml</arg>
              <arg>config/database.yml</arg>
              <runif status="passed" />
            </exec>
            <exec command="bash">
              <arg>-c</arg>
              <arg><%= @params[:init] %></arg>
              <runif status="passed" />
            </exec>
            <exec command="bash">
              <arg>-c</arg>
              <arg><%= @params[:ruby] %> -S bundle exec rake --trace db:drop db:create db:migrate</arg>
              <runif status="passed" />
            </exec>
            <exec command="bash">
              <arg>-c</arg>
              <arg><%= @params[:ruby] %> -S bundle exec rake --trace twist:run_tests</arg>
              <runif status="passed" />
            </exec>
            <exec command="bash">
              <arg>-c</arg>
              <arg><%= @params[:ruby] %> -S bundle exec rake --trace twist:server:stop</arg>
              <runif status="any" />
            </exec>
          </tasks>
        </job>
      </jobs>
    </stage>
  <% end %>
  </pipeline>
</pipelines>
