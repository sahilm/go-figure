<pipelines group="defaultGroup">
  <pipeline name="defaultPipeline">
    <%if @params[:custom]%>
     <environmentvariables>
       <%@params[:custom].each do |key, value|%>
        <variable name="<%=key%>">
          <value><%=value%></value>
        </variable>
       <%end%>
      </environmentvariables>
    <%end%>
    <materials>
      <git autoUpdate="false" url="<%= @git_url %>" />
    </materials>
    <stage name="RailsTests">
      <jobs>
        <job name="Test">
          <tasks>
            <exec command="/bin/ln">
              <arg>-sf</arg>
              <arg>/etc/go_saas/database.yml</arg>
              <arg>config/database.yml</arg>
              <runif status="passed" />
            </exec>
            <exec command="bash">
              <arg>-c</arg>
              <arg><%= @params[:init] %></arg>
              <runif status="passed" />
            </exec>
            <exec command="bash">
              <arg>-c</arg>
              <arg><%= @params[:ruby] %> -S bundle exec rake db:create db:migrate</arg>
              <runif status="passed" />
            </exec>
            <% if @params[:test_unit] %>
            <exec command="bash">
              <arg>-c</arg>
              <arg><%= @params[:ruby] %> -S bundle exec rake test</arg>
              <runif status="passed" />
            </exec>
            <%end%>
            <% if @params[:rspec] %>
            <exec command="bash">
              <arg>-c</arg>
              <arg><%= @params[:ruby] %> -S bundle exec rake spec</arg>
              <runif status="passed" />
            </exec>
            <%end%>
          </tasks>
        </job>
      </jobs>
    </stage>
  <% if @params[:jasmine] %>
    <stage name="BrowserTests">
      <jobs>
        <job name="Jasmine">
          <environmentvariables>
            <variable name="DISPLAY">
              <value>:1</value>
            </variable>
          </environmentvariables>
          <tasks>
            <exec command="/bin/ln">
              <arg>-sf</arg>
              <arg>/etc/go_saas/database.yml</arg>
              <arg>config/database.yml</arg>
              <runif status="passed" />
            </exec>
            <exec command="bash">
              <arg>-c</arg>
              <arg><%= @params[:init] %></arg>
              <runif status="passed" />
            </exec>
            <exec command="bash">
              <arg>-c</arg>
              <arg><%= @params[:ruby] %> -S bundle exec rake db:create db:migrate</arg>
              <runif status="passed" />
            </exec>
            <exec command="bash">
              <arg>-c</arg>
              <arg><%= @params[:ruby] %> -S bundle exec rake jasmine:headless</arg>
              <runif status="passed" />
            </exec>
          </tasks>
        </job>
      </jobs>
    </stage>
  <% end %>
  </pipeline>
</pipelines>
