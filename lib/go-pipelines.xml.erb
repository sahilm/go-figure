<pipelines group="defaultGroup">
  <pipeline name="defaultPipeline">
    <materials>
      <git autoUpdate="false" url="<%= @git_url %>" />
    </materials>
    <stage name="Units">
      <jobs>
        <job name="Test">
          <tasks>
            <exec command="/bin/ln">
              <arg>-sf</arg>
              <arg>/etc/go_saas/database.yml</arg>
              <arg>config/database.yml</arg>
              <runif status="passed" />
            </exec>
            <exec command="bundle">
              <arg>install</arg>
              <arg>--local</arg>
              <arg>--path</arg>
              <arg>.bundle</arg>
              <runif status="passed" />
            </exec>
            <exec command="bundle">
              <arg>exec</arg>
              <arg>rake</arg>
              <arg>db:create</arg>
              <arg>db:migrate</arg>
              <runif status="passed" />
            </exec>
            <% if @params[:test_unit] %>
            <exec command="bundle">
              <arg>exec</arg>
              <arg>rake</arg>
              <arg>test</arg>
              <runif status="passed" />
            </exec>
            <%end%>
            <% if @params[:rspec] %>
            <exec command="bundle">
              <arg>exec</arg>
              <arg>rake</arg>
              <arg>spec</arg>
              <runif status="passed" />
            </exec>
            <%end%>
          </tasks>
        </job>
      </jobs>
    </stage>

  <% if @params[:jasmine] %>
    <stage name="Functionals">
      <jobs>
        <job name="Jasmine">
          <environmentvariables>
            <variable name="DISPLAY">
              <value>:1</value>
            </variable>
          </environmentvariables>
          <tasks>
            <exec command="/bin/ln">
              <arg>-sf</arg>
              <arg>/etc/go_saas/database.yml</arg>
              <arg>config/database.yml</arg>
              <runif status="passed" />
            </exec>
            <exec command="bundle">
              <arg>install</arg>
              <arg>--local</arg>
              <arg>--path</arg>
              <arg>.bundle</arg>
              <runif status="passed" />
            </exec>
            <exec command="bundle">
              <arg>exec</arg>
              <arg>rake</arg>
              <arg>db:create</arg>
              <arg>db:migrate</arg>
              <runif status="passed" />
            </exec>
            <exec command="bundle">
              <arg>exec</arg>
              <arg>rake</arg>
              <arg>jasmine:headless</arg>
              <runif status="passed" />
            </exec>
          </tasks>
        </job>
      </jobs>
    </stage>
  <% end %>
  </pipeline>
</pipelines>
